<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wortfinder</title>

    <!-- PWA / "Zum Home-Bildschirm hinzufügen" Konfiguration -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#FF8C00">

    <!-- Speziell für Apple-Geräte (iOS/iPadOS) -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Wortfinder">
    <link rel="apple-touch-icon" href="icon-192x192.png">

    <!-- Einbinden der Schriftart "Lexend" -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@400;700&display=swap" rel="stylesheet">


    <style>
        /* CSS-Variablen und grundlegende Stile */
        :root {
            --primary-color: #FF8C00; --background-color: #1a1a1a; --container-bg-color: #2b2b2b; --text-color: #f0f0f0; --success-color: #4CAF50; --error-color: #f44336;
            --border-color: #444; --button-bg: #333; --button-hover-bg: #555; --active-bg: var(--primary-color); --active-text: #000;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: var(--background-color); color: var(--text-color); overflow: hidden; }
        .screen { display: none; flex-direction: column; align-items: center; justify-content: center; height: 100dvh; /* dvh statt vh für mobile Browser */ width: 100vw; padding: 20px; }
        .screen.active { display: flex; }
        h1 { color: var(--primary-color); text-shadow: 2px 2px 4px rgba(0,0,0,0.5); margin-bottom: 25px; font-size: 2.5em; }
        
        /* Setup-Screen */
        #setup-screen .container { background-color: var(--container-bg-color); padding: 25px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); max-width: 600px; width: 100%; }
        .selector-group { display: flex; gap: 15px; margin-bottom: 20px; align-items: start; }
        .selector-group > div { flex: 1; }
        
        /* NEUE Stile für den Listen-Kombinierer */
        #list-selector-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 10px;
        }
        #add-list-btn {
            padding: 5px 12px;
            font-size: 1.2em;
            font-weight: bold;
            line-height: 1;
            cursor: pointer;
            border: 1px solid var(--border-color);
            background-color: var(--button-bg);
            color: var(--text-color);
            border-radius: 5px;
            transition: background-color 0.2s;
        }
        #add-list-btn:hover:not(:disabled) {
            background-color: var(--button-hover-bg);
        }
        #add-list-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        select { width: 100%; padding: 10px; font-size: 1em; background-color: #1e1e1e; color: var(--text-color); border: 1px solid var(--border-color); border-radius: 5px; }
        .settings-box { border: 1px solid var(--border-color); padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        .settings-box h2 { margin-top: 0; margin-bottom: 15px; font-size: 1.2em; color: var(--primary-color); }
        .settings-group { margin-bottom: 20px; }
        .settings-group label { display: block; margin-bottom: 10px; font-weight: bold; }
        .btn-group { display: flex; flex-wrap: wrap; gap: 5px; }
        .btn-group button { padding: 8px 12px; border: 1px solid var(--border-color); background-color: var(--button-bg); color: var(--text-color); cursor: pointer; transition: background-color 0.2s; border-radius: 5px; }
        .btn-group button:hover { background-color: var(--button-hover-bg); }
        .btn-group button.active { background-color: var(--active-bg); color: var(--active-text); font-weight: bold; }
        #conditional-settings .setting-block { display: none; } #conditional-settings .setting-block.active { display: block; }
        .slider-container { display: flex; align-items: center; gap: 15px; }
        input[type="range"] { flex-grow: 1; -webkit-appearance: none; appearance: none; width: 100%; height: 8px; background: #444; outline: none; border-radius: 5px; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 20px; height: 20px; background: var(--primary-color); cursor: pointer; border-radius: 50%; }
        input[type="range"]::-moz-range-thumb { width: 20px; height: 20px; background: var(--primary-color); cursor: pointer; border-radius: 50%; }
        .slider-value { font-weight: bold; min-width: 60px; text-align: right; }
        .action-buttons { display: flex; gap: 15px; margin-top: 20px; }
        .btn { padding: 12px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: 1em; font-weight: bold; transition: transform 0.2s, box-shadow 0.2s; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.3); }
        .btn-primary { flex-grow: 1; background-color: var(--primary-color); color: var(--active-text); }
        .btn-secondary { background-color: var(--button-bg); color: var(--text-color); }
        #error-message { color: var(--error-color); margin-top: 15px; font-weight: bold; display: none; }
        
        #start-screen-logo { position: absolute; bottom: 100px; right: 100px; width: 100px; height: 100px; pointer-events: none; }

        /* Game-Screen */
        #game-screen { justify-content: flex-start; padding: 0; } 
        #game-hud { width: 100%; background-color: rgba(0,0,0,0.7); padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; z-index: 100; flex-shrink: 0; }
        #game-stats, #game-actions { display: flex; align-items: center; gap: 20px; } #game-stats span { font-size: 1.2em; }
        #target-word-display { font-size: 1.5em; font-weight: bold; color: var(--primary-color); text-align: center; visibility: hidden; }
        #game-area { position: relative; width: 100%; flex: 1; overflow: hidden; padding: 10px; }
        
        /* Wortwolke-Modus Stile */
        .game-word { position: absolute; padding: 8px 15px; background-color: rgba(43, 43, 43, 0.9); border: 1px solid var(--border-color); border-radius: 5px; cursor: pointer; user-select: none; font-size: 2em; transition: transform 0.2s, background-color 0.3s; }
        .game-word:hover { transform: scale(1.1); border-color: var(--primary-color); }
        .word-fly-in { left: 0; animation-name: fly-across; animation-timing-function: linear; white-space: nowrap; }
        @keyframes fly-across { from { transform: translateX(-100%); } to { transform: translateX(100vw); } }

        /* Lesemodus Stile */
        #game-area.reading-mode-active { display: flex; justify-content: center; align-items: center; }
        #reading-page-container { width: 100%; height: 100%; background-color: var(--container-bg-color); box-shadow: 0 4px 15px rgba(0,0,0,0.3); border-radius: 10px; overflow: hidden; display: grid; grid-template-rows: repeat(var(--grid-rows, 7), 1fr); grid-template-columns: repeat(var(--grid-cols, 10), 1fr); gap: 5px; }
        .reading-word { display: flex; justify-content: center; align-items: center; cursor: pointer; border-radius: 4px; transition: background-color 0.2s, color 0.2s; user-select: none; line-height: 1; font-family: 'Lexend', sans-serif; }
        .reading-word:hover { background-color: var(--button-hover-bg); }
        .reading-word.correct { background-color: var(--success-color) !important; color: white !important; cursor: default; }
        
        /* ===== KORRIGIERTE Emoji-Quiz Stile ===== */
        .emoji-quiz-container { display: flex; flex-direction: column; justify-content: center; align-items: center; width: 100%; height: 100%; gap: 40px; }
        .emoji-display {
            font-size: 10em;
            text-shadow: 0 5px 15px rgba(0,0,0,0.4);
            user-select: none;
            font-family: 'Lexend', sans-serif; /* KORREKTUR: Schriftart hinzugefügt */
        }
        .choice-options { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; width: 100%; max-width: 800px; }
        .choice-btn {
            padding: 20px;
            font-size: 1.5em;
            background-color: var(--button-bg);
            color: var(--text-color);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: 'Lexend', sans-serif; /* Schriftart ist hier korrekt */
        }
        .choice-btn:hover:not(:disabled) { background-color: var(--button-hover-bg); border-color: var(--primary-color); transform: translateY(-3px); }
        .choice-btn:disabled { cursor: not-allowed; opacity: 0.7; }
        @media (max-width: 600px) {
            .emoji-display { font-size: 8em; }
            .choice-options { grid-template-columns: 1fr; gap: 15px; }
            .choice-btn { font-size: 1.2em; padding: 15px; }
        }
        /* ===== ENDE der korrigierten Stile ===== */

        /* Allgemeine Effekte & Animationen */
        .fade-out { animation: fade-out-anim 0.3s forwards; } @keyframes fade-out-anim { to { opacity: 0; transform: scale(0.5); } }
        .correct { background-color: var(--success-color) !important; color: white !important; border-color: var(--success-color) !important; } 
        .incorrect { background-color: var(--error-color) !important; color: white !important; border-color: var(--error-color) !important; }
        .shake { animation: shake-anim 0.5s; } @keyframes shake-anim { 10%, 90% { transform: translateX(-3px); } 20%, 80% { transform: translateX(3px); } 30%, 50%, 70% { transform: translateX(-3px); } 40%, 60% { transform: translateX(3px); } }
        
        /* Game-Over Screen Stile */
        #game-over-screen { justify-content: flex-start; overflow: hidden; }
        #game-over-animation-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; overflow: hidden; z-index: 5; }
        .rain-word { position: absolute; color: var(--primary-color); font-weight: bold; white-space: nowrap; user-select: none; pointer-events: none; will-change: transform; animation-name: word-rain-fall; animation-timing-function: linear; animation-fill-mode: forwards; opacity: 0; }
        @keyframes word-rain-fall { 0% { transform: translateY(-50vh) rotate(var(--start-rot)); opacity: 0; } 5% { opacity: 1; } 100% { transform: translateY(110vh) rotate(var(--end-rot)); opacity: 1; } }
        #game-over-content { display: none; flex-direction: column; align-items: center; justify-content: center; width: 100%; height: 100%; z-index: 10; animation: fadeInContent 1s ease-in forwards; }
        @keyframes fadeInContent { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
    </style>
</head>
<body>

    <div id="setup-screen" class="screen active">
        <div class="container">
            <h1 id="main-title">Wortfinder: Setup</h1>
            <div class="selector-group">
                <div> 
                    <label for="topic-selector">Thema</label> 
                    <select id="topic-selector"></select> 
                </div>
                <div> 
                    <label>Liste(n)</label>
                    <div id="list-selector-container">
                        <!-- Select-Elemente werden hier von JavaScript eingefügt -->
                    </div>
                    <button id="add-list-btn" title="Weitere Liste hinzufügen">+</button>
                </div>
            </div>
            <div class="settings-box">
                <h2>Einstellungen</h2>
                <div class="settings-group">
                    <label>Spielmodus</label>
                    <div class="btn-group">
                        <button id="mode-wordcloud" class="active">Wortwolke</button>
                        <button id="mode-reading">Lesemodus</button>
                        <button id="mode-emoji-quiz">Emoji-Quiz</button>
                    </div>
                </div>
                <div class="settings-group"> <label>Ton</label> <div class="btn-group"> <button id="sound-toggle-btn" class="active">An</button> </div> </div>
                <div id="conditional-settings">
                    <div id="wordcloud-settings" class="setting-block active">
                        <div class="settings-group"> <label for="target-frequency-slider">Zielwort-Häufigkeit</label> <div class="slider-container"> <input type="range" id="target-frequency-slider" min="10" max="50" value="30" step="5"> <span id="target-frequency-value" class="slider-value">30%</span> </div> </div>
                        <div class="settings-group"> <label for="base-speed-slider">Grundgeschwindigkeit</label> <div class="slider-container"><input type="range" id="base-speed-slider" min="5000" max="20000" value="10000" step="500"><span id="base-speed-value" class="slider-value">10.0s</span></div> </div>
                        <div class="settings-group"> <label for="speed-variance-slider">Tempo-Varianz</label> <div class="slider-container"><input type="range" id="speed-variance-slider" min="0" max="50" value="20" step="5"><span id="speed-variance-value" class="slider-value">±20%</span></div> </div>
                    </div>
                    <div id="reading-mode-settings" class="setting-block">
                        <div class="settings-group"> <label>Rastergröße (Dichte)</label> <div class="btn-group"> <button id="grid-small">Klein (5x8)</button> <button id="grid-medium" class="active">Mittel (7x10)</button> <button id="grid-large">Groß (9x12)</button> </div> </div>
                    </div>
                </div>
            </div>
            <div class="action-buttons"> <button id="start-game-btn" class="btn btn-primary">Spiel starten</button> <button id="fullscreen-btn" class="btn btn-secondary">Vollbild</button> </div>
            <p id="error-message"></p>
        </div>
        <img src="logo.png" alt="Firmenlogo" id="start-screen-logo">
    </div>
    
    <div id="game-screen" class="screen"><div id="game-hud"><div id="game-stats"><span id="level-display">Level: 1</span><span id="hits-display">Treffer: 0 / 10</span></div><div id="target-word-display"></div><div id="game-actions"><button id="exit-game-btn" class="btn btn-secondary">Beenden</button><button id="fullscreen-btn-game" class="btn btn-secondary">Vollbild</button></div></div><div id="game-area"></div></div>

    <div id="game-over-screen" class="screen">
        <div id="game-over-animation-container"></div>
        <div id="game-over-content" style="display: none; text-align: center;">
            <h1>Toll gemacht!</h1>
            <p>Du hast alle Wörter gemeistert.</p>
            <div class="action-buttons" style="justify-content: center;">
                <button id="repeat-game-btn" class="btn btn-primary">Wiederholen</button>
                <button id="new-selection-btn" class="btn btn-secondary">Neue Auswahl</button>
            </div>
        </div>
    </div>

    <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js').then(registration => {
          console.log('ServiceWorker registration successful with scope: ', registration.scope);
        }, err => {
          console.log('ServiceWorker registration failed: ', err);
        });
      });
    }

    document.addEventListener('DOMContentLoaded', () => {
        let WORD_DATA = {};
        const TOPICS_TO_LOAD = { 
            "Artikulation (Emoji)": "artikulation.json", 
            "Wortschatz (Emoji)": "wortschatz.json", 
            "Lesen Artikulation": "lesen_artikulation.json",
            "Lesen Rechtschreibung": "lesen_rechtschreibung.json",
            "Lesen Buchstaben": "lesen_buchstaben.json",
            "Lesen einfache Wörter": "lesen_einfache_woerter.json"
        };
        
        const MAX_COMBINED_LISTS = 4;
        
        const GRID_CONFIGS = {
            small:  { rows: 5, cols: 8,  total: 40 },
            medium: { rows: 7, cols: 10, total: 70 },
            large:  { rows: 9, cols: 12, total: 108 }
        };

        const screens = { setup: document.getElementById('setup-screen'), game: document.getElementById('game-screen'), gameOver: document.getElementById('game-over-screen') };
        const setup = {
            topicSelector: document.getElementById('topic-selector'), 
            listSelectorContainer: document.getElementById('list-selector-container'),
            addListBtn: document.getElementById('add-list-btn'),
            modeWordCloudBtn: document.getElementById('mode-wordcloud'), modeReadingBtn: document.getElementById('mode-reading'),
            modeEmojiQuizBtn: document.getElementById('mode-emoji-quiz'),
            wordCloudSettings: document.getElementById('wordcloud-settings'), readingModeSettings: document.getElementById('reading-mode-settings'),
            startGameBtn: document.getElementById('start-game-btn'),
            errorMessage: document.getElementById('error-message'), baseSpeedSlider: document.getElementById('base-speed-slider'),
            baseSpeedValue: document.getElementById('base-speed-value'), speedVarianceSlider: document.getElementById('speed-variance-slider'),
            speedVarianceValue: document.getElementById('speed-variance-value'),
            targetFrequencySlider: document.getElementById('target-frequency-slider'),
            targetFrequencyValue: document.getElementById('target-frequency-value'),
            gridSmallBtn: document.getElementById('grid-small'),
            gridMediumBtn: document.getElementById('grid-medium'),
            gridLargeBtn: document.getElementById('grid-large'),
            soundToggleBtn: document.getElementById('sound-toggle-btn'),
        };
        const game = { levelDisplay: document.getElementById('level-display'), hitsDisplay: document.getElementById('hits-display'), targetWordDisplay: document.getElementById('target-word-display'), area: document.getElementById('game-area'), exitBtn: document.getElementById('exit-game-btn') };
        
        const fullscreenBtns = [document.getElementById('fullscreen-btn'), document.getElementById('fullscreen-btn-game')];
        let state = {
            gameMode: 'wordcloud', numLanes: 7, laneStates: [], baseAnimationSpeed: 10000,
            speedVariance: 20, targetWordFrequency: 30,
            readingGridSize: 'medium', 
            wordList: [], usedTargetWords: [], targetWord: null, level: 1, hits: 0, hitsNeeded: 10, gameInterval: null,
            levelWirdGewechselt: false
        };

        let audioCtx = null;
        let clickSoundBuffer = null;
        let completionSoundBuffer = null;
        let fanfareSoundBuffer = null;
        let soundsEnabled = true;
        
        async function loadAudioBuffer(url) {
            if (!audioCtx) return null;
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`HTTP-Fehler ${response.status} für ${url}`);
                const arrayBuffer = await response.arrayBuffer();
                const audioBuffer = await audioCtx.decodeAudioData(arrayBuffer);
                return audioBuffer;
            } catch (e) {
                console.error(`Fehler beim Laden der Audiodatei: ${url}`, e);
                setup.errorMessage.textContent = `Sounddatei ${url} konnte nicht geladen werden.`;
                setup.errorMessage.style.display = 'block';
                return null;
            }
        }

        async function initAudio() {
            if (audioCtx) return;
            try {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                await createSounds();
            } catch (e) {
                console.error("Web Audio API wird von diesem Browser nicht unterstützt.", e);
                soundsEnabled = false; 
                setup.soundToggleBtn.style.display = 'none';
            }
        }
        
        async function createSounds() {
            if (!audioCtx) return;
            let clickDuration = 0.05;
            clickSoundBuffer = audioCtx.createBuffer(1, audioCtx.sampleRate * clickDuration, audioCtx.sampleRate);
            const clickData = clickSoundBuffer.getChannelData(0);
            for (let i = 0; i < clickData.length; i++) {
                clickData[i] = Math.sin(2 * Math.PI * 880 * (i / audioCtx.sampleRate)) * Math.exp(-i / (audioCtx.sampleRate * 0.01));
            }

            let completionDuration = 0.4;
            completionSoundBuffer = audioCtx.createBuffer(1, audioCtx.sampleRate * completionDuration, audioCtx.sampleRate);
            const completionData = completionSoundBuffer.getChannelData(0);
            const tone1Duration = 0.15; const tone2Start = 0.2;
            for (let i = 0; i < completionData.length; i++) {
                const time = i / audioCtx.sampleRate;
                if (time < tone1Duration) { completionData[i] = Math.sin(2 * Math.PI * 523.25 * time) * Math.exp(-time * 10); } 
                else if (time >= tone2Start && time < completionDuration) { const time2 = time - tone2Start; completionData[i] = Math.sin(2 * Math.PI * 783.99 * time2) * Math.exp(-time2 * 10); }
            }
            
            fanfareSoundBuffer = await loadAudioBuffer('fanfare.mp3');
        }

        function playSound(buffer) {
            if (!soundsEnabled || !audioCtx || !buffer) return;
            if (audioCtx.state === 'suspended') { audioCtx.resume(); }
            const source = audioCtx.createBufferSource();
            source.buffer = buffer;
            source.connect(audioCtx.destination);
            source.start(0);
        }

        function toggleSounds() { soundsEnabled = !soundsEnabled; updateSetupUI(); }
        
        async function initializeApp() {
            await loadWordData();
            populateTopicSelector();
            resetAndPopulateListSelectors();
            updateSetupUI();
            
            setup.topicSelector.addEventListener('change', resetAndPopulateListSelectors);
            setup.addListBtn.addEventListener('click', addListSelector);
            setup.modeWordCloudBtn.addEventListener('click', () => { state.gameMode = 'wordcloud'; updateSetupUI(); });
            setup.modeReadingBtn.addEventListener('click', () => { state.gameMode = 'reading'; updateSetupUI(); });
            setup.modeEmojiQuizBtn.addEventListener('click', () => { state.gameMode = 'emojiQuiz'; updateSetupUI(); });
            setup.baseSpeedSlider.addEventListener('input', (e) => { state.baseAnimationSpeed = parseInt(e.target.value); updateSetupUI(); });
            setup.speedVarianceSlider.addEventListener('input', (e) => { state.speedVariance = parseInt(e.target.value); updateSetupUI(); });
            setup.targetFrequencySlider.addEventListener('input', (e) => { state.targetWordFrequency = parseInt(e.target.value); updateSetupUI(); });
            setup.gridSmallBtn.addEventListener('click', () => { state.readingGridSize = 'small'; updateSetupUI(); });
            setup.gridMediumBtn.addEventListener('click', () => { state.readingGridSize = 'medium'; updateSetupUI(); });
            setup.gridLargeBtn.addEventListener('click', () => { state.readingGridSize = 'large'; updateSetupUI(); });
            
            setup.startGameBtn.addEventListener('click', startGame);
            game.exitBtn.addEventListener('click', () => { clearInterval(state.gameInterval); showScreen('setup'); });
            fullscreenBtns.forEach(btn => btn.addEventListener('click', toggleFullscreen));
            setup.soundToggleBtn.addEventListener('click', toggleSounds);

            document.getElementById('repeat-game-btn').addEventListener('click', startGame); 
            document.getElementById('new-selection-btn').addEventListener('click', () => showScreen('setup'));
        }
        
        async function startGame() {
            await initAudio(); 
            const selectedTopic = setup.topicSelector.value;
            
            const selectedLists = Array.from(setup.listSelectorContainer.querySelectorAll('select'))
                                       .map(sel => sel.value);

            const uniqueWordsMap = new Map();
            selectedLists.forEach(listName => {
                if(WORD_DATA[selectedTopic] && WORD_DATA[selectedTopic][listName]) {
                    const words = WORD_DATA[selectedTopic][listName];
                    words.forEach(word => {
                        if (!uniqueWordsMap.has(word.title)) {
                            uniqueWordsMap.set(word.title, word);
                        }
                    });
                }
            });
            const combinedWordList = Array.from(uniqueWordsMap.values());
            
            const minWords = state.gameMode === 'emojiQuiz' ? 4 : 2;

            if (!combinedWordList.length || combinedWordList.length < minWords) { 
                setup.errorMessage.textContent = `Für diesen Modus müssen die kombinierten Listen mindestens ${minWords} verschiedene Elemente enthalten.`;
                setup.errorMessage.style.display = 'block';
                return;
            }

            setup.errorMessage.style.display = 'none';
            state.wordList = combinedWordList;
            state.level = 1;
            state.hits = 0;
            state.usedTargetWords = [];
            showScreen('game');
            startLevel();
        }

        function startLevel() {
            state.levelWirdGewechselt = false;

            if (state.usedTargetWords.length >= state.wordList.length) {
                endGame();
                return;
            }
            let availableWords = state.wordList.filter(w => !state.usedTargetWords.includes(w));
            state.targetWord = availableWords[Math.floor(Math.random() * availableWords.length)];
            state.usedTargetWords.push(state.targetWord);
            
            game.area.innerHTML = '';
            clearInterval(state.gameInterval);
            game.area.classList.remove('reading-mode-active');

            if (state.gameMode === 'reading') {
                game.area.classList.add('reading-mode-active');
                startReadingMode();
            } else if (state.gameMode === 'emojiQuiz') {
                startEmojiQuizMode();
            } else {
                startWordCloudMode();
            }
        }
        
        function updateHUD() {
            game.levelDisplay.textContent = `Level: ${state.level} von ${state.wordList.length}`;
            game.hitsDisplay.textContent = `Treffer: ${state.hits} / ${state.hitsNeeded}`;

            let displayText;
            if (state.gameMode === 'emojiQuiz') {
                displayText = state.targetWord.emoji;
            } else {
                if (state.targetWord.title === state.targetWord.emoji || !state.targetWord.title) {
                    displayText = state.targetWord.emoji;
                } else {
                    displayText = `${state.targetWord.title} ${state.targetWord.emoji}`;
                }
            }
            
            const labelText = state.gameMode === 'emojiQuiz' ? 'Welches Wort passt zu: ' : 'Ziel: ';
            game.targetWordDisplay.textContent = labelText + displayText;
            game.targetWordDisplay.style.visibility = 'visible';
        }

        function startWordCloudMode() { state.laneStates = Array(state.numLanes).fill(0); state.hitsNeeded = 10; state.hits = 0; updateHUD(); state.gameInterval = setInterval(spawnWordRain, 350); }
        function spawnWordRain() { if (document.hidden) return; const now = Date.now(); const freeLanes = []; for (let i = 0; i < state.numLanes; i++) { if (state.laneStates[i] < now) freeLanes.push(i); } if (freeLanes.length === 0) return; let wordToSpawn; const probabilityThreshold = state.targetWordFrequency / 100; if (Math.random() < probabilityThreshold) { wordToSpawn = state.targetWord; } else { const distractors = state.wordList.filter(w => w !== state.targetWord); wordToSpawn = distractors.length > 0 ? distractors[Math.floor(Math.random() * distractors.length)] : state.targetWord;} const laneIndex = freeLanes[Math.floor(Math.random() * freeLanes.length)]; const el = document.createElement('div'); el.textContent = wordToSpawn.emoji; el.classList.add('game-word', 'word-fly-in'); const areaRect = game.area.getBoundingClientRect(); const laneHeight = areaRect.height / state.numLanes; el.style.top = `${laneIndex * laneHeight + Math.random() * (laneHeight - 40)}px`; const varianceAmount = state.baseAnimationSpeed * (state.speedVariance / 100); const randomDeviation = (Math.random() * 2 - 1) * varianceAmount; const finalAnimationDuration = Math.max(2000, state.baseAnimationSpeed + randomDeviation); el.style.animationDuration = `${finalAnimationDuration}ms`; el.addEventListener('pointerdown', handleWordCloudClick); el.addEventListener('touchstart', handleWordCloudClick, { passive: true }); game.area.appendChild(el); const wordWidth = el.offsetWidth; const pixelsPerSecond = (areaRect.width + wordWidth) / (finalAnimationDuration / 1000); const clearanceTime = (wordWidth + 100) / pixelsPerSecond; state.laneStates[laneIndex] = now + clearanceTime * 1000; setTimeout(() => el.remove(), finalAnimationDuration); }
        function handleWordCloudClick(e) { if (state.levelWirdGewechselt) return; const el = e.target; if (el.dataset.clicked) return; el.dataset.clicked = 'true'; el.style.transform = getComputedStyle(el).transform; el.style.animation = 'none'; el.style.pointerEvents = 'none'; if (el.textContent === state.targetWord.emoji) { playSound(clickSoundBuffer); state.hits++; el.classList.add('correct'); updateHUD(); if (state.hits >= state.hitsNeeded) { state.levelWirdGewechselt = true; playSound(completionSoundBuffer); clearInterval(state.gameInterval); setTimeout(() => { state.level++; startLevel(); }, 1000); } } else { el.classList.add('incorrect', 'shake'); } setTimeout(() => { el.classList.add('fade-out'); setTimeout(() => el.remove(), 300); }, 500); }
        async function startReadingMode() { updateHUD(); await new Promise(resolve => setTimeout(resolve, 0)); const config = GRID_CONFIGS[state.readingGridSize]; const TOTAL_WORDS = config.total; const TARGET_COUNT = Math.min(25, Math.max(5, Math.round(TOTAL_WORDS * 0.17))); state.hitsNeeded = TARGET_COUNT; state.hits = 0; const distractors = state.wordList.filter(w => w !== state.targetWord); let wordsForPage = []; for (let i = 0; i < TARGET_COUNT; i++) { wordsForPage.push(state.targetWord.emoji); } for (let i = 0; i < TOTAL_WORDS - TARGET_COUNT; i++) { wordsForPage.push(distractors.length > 0 ? distractors[Math.floor(Math.random() * distractors.length)].emoji : state.targetWord.emoji); } shuffleArray(wordsForPage); const longestWord = wordsForPage.reduce((a, b) => a.length > b.length ? a : b, ""); const cellPadding = 10; const cellWidth = (game.area.clientWidth / config.cols) - cellPadding; const cellHeight = (game.area.clientHeight / config.rows) - cellPadding; const optimalFontSize = calculateOptimalFontSize(longestWord, cellWidth, cellHeight); const pageContainer = document.createElement('div'); pageContainer.id = 'reading-page-container'; pageContainer.style.setProperty('--grid-rows', config.rows); pageContainer.style.setProperty('--grid-cols', config.cols); wordsForPage.forEach(word => { const wordSpan = document.createElement('span'); wordSpan.textContent = word; wordSpan.classList.add('reading-word'); wordSpan.addEventListener('click', handleReadingWordClick); wordSpan.style.fontSize = `${optimalFontSize}px`; pageContainer.appendChild(wordSpan); }); game.area.appendChild(pageContainer); updateHUD(); }
        function handleReadingWordClick(e) { if (state.levelWirdGewechselt) return; const el = e.target; if (el.classList.contains('correct')) return; if (el.textContent === state.targetWord.emoji) { playSound(clickSoundBuffer); el.classList.add('correct'); el.classList.remove('incorrect', 'shake'); state.hits++; updateHUD(); if (state.hits >= state.hitsNeeded) { state.levelWirdGewechselt = true; playSound(completionSoundBuffer); setTimeout(() => { state.level++; startLevel(); }, 1200); } } else { el.classList.add('incorrect', 'shake'); setTimeout(() => el.classList.remove('incorrect', 'shake'), 500); } }

        function startEmojiQuizMode() {
            state.hits = 0;
            state.hitsNeeded = 1;
            updateHUD();

            const distractors = new Set();
            const potentialDistractors = state.wordList.filter(w => w.title !== state.targetWord.title);
            shuffleArray(potentialDistractors);
            
            for(const item of potentialDistractors) {
                if(distractors.size < 3) { distractors.add(item.title); } else { break; }
            }
            
            const choices = [state.targetWord.title, ...Array.from(distractors)];
            shuffleArray(choices);

            const container = document.createElement('div');
            container.className = 'emoji-quiz-container';

            const emojiDisplay = document.createElement('div');
            emojiDisplay.className = 'emoji-display';
            emojiDisplay.textContent = state.targetWord.emoji;

            const optionsContainer = document.createElement('div');
            optionsContainer.className = 'choice-options';

            choices.forEach(choiceText => {
                const btn = document.createElement('button');
                btn.className = 'choice-btn';
                btn.textContent = choiceText;
                btn.addEventListener('click', handleEmojiQuizChoice);
                optionsContainer.appendChild(btn);
            });

            container.appendChild(emojiDisplay);
            container.appendChild(optionsContainer);
            game.area.appendChild(container);
        }

        function handleEmojiQuizChoice(e) {
            if (state.levelWirdGewechselt) return;

            const clickedButton = e.target;
            const isCorrect = clickedButton.textContent === state.targetWord.title;

            if (isCorrect) {
                state.levelWirdGewechselt = true;
                const allButtons = game.area.querySelectorAll('.choice-btn');
                allButtons.forEach(btn => btn.disabled = true);
                
                clickedButton.classList.add('correct');
                playSound(completionSoundBuffer);
                state.hits++;
                updateHUD();

                setTimeout(() => {
                    state.level++;
                    startLevel();
                }, 1500);

            } else {
                clickedButton.disabled = true;
                clickedButton.classList.add('incorrect', 'shake');
                playSound(clickSoundBuffer);
                setTimeout(() => {
                    clickedButton.classList.remove('incorrect', 'shake');
                    clickedButton.disabled = false;
                }, 600);
            }
        }

        function shuffleArray(array) { for (let i = array.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [array[i], array[j]] = [array[j], array[i]]; } return array; }
        function calculateOptimalFontSize(text, maxWidth, maxHeight) { const meter = document.createElement('span'); meter.classList.add('reading-word'); meter.style.position = 'absolute'; meter.style.visibility = 'hidden'; meter.style.whiteSpace = 'nowrap'; meter.textContent = text; document.body.appendChild(meter); let fontSize = 100; meter.style.fontSize = `${fontSize}px`; while ((meter.offsetWidth > maxWidth || meter.offsetHeight > maxHeight) && fontSize > 8) { fontSize--; meter.style.fontSize = `${fontSize}px`; } document.body.removeChild(meter); return Math.max(fontSize * 0.9, 8); }
        
        async function loadWordData() {
            try {
                const fetchPromises = Object.entries(TOPICS_TO_LOAD).map(async ([topicName, fileName]) => {
                    const response = await fetch(fileName);
                    if (!response.ok) throw new Error(`${fileName}: ${response.statusText}`);
                    let topicData = await response.json();
                    for (const listName in topicData) {
                        const list = topicData[listName];
                        if (Array.isArray(list) && list.length > 0 && typeof list[0] === 'string') {
                            topicData[listName] = list.map(word => ({ title: word, emoji: word }));
                        }
                    }
                    WORD_DATA[topicName] = topicData; 
                });
                await Promise.all(fetchPromises);
            } catch (error) {
                console.error("Fehler beim Laden der Wortlisten:", error);
                document.getElementById('main-title').textContent = "Fehler!";
                setup.errorMessage.textContent = `Wortlisten konnten nicht geladen werden. Prüfe die Konsole (F12) und ob die JSON-Dateien im selben Ordner liegen.`;
                setup.errorMessage.style.display = 'block';
                setup.startGameBtn.disabled = true;
                throw error;
            }
        }

        function populateTopicSelector() { setup.topicSelector.innerHTML = ''; Object.keys(WORD_DATA).forEach(topicName => { const option = document.createElement('option'); option.value = topicName; option.textContent = topicName; setup.topicSelector.appendChild(option); }); }
        
        function resetAndPopulateListSelectors() {
            setup.listSelectorContainer.innerHTML = '';
            addListSelector();
        }

        function addListSelector() {
            const currentSelectors = setup.listSelectorContainer.querySelectorAll('select');
            if (currentSelectors.length >= MAX_COMBINED_LISTS) {
                return;
            }

            const newSelect = document.createElement('select');
            newSelect.addEventListener('change', updateAddButtonAndOptions);
            setup.listSelectorContainer.appendChild(newSelect);
            
            updateAddButtonAndOptions();
        }

        function updateAddButtonAndOptions() {
            const currentSelectors = Array.from(setup.listSelectorContainer.querySelectorAll('select'));
            const selectedValues = currentSelectors.map(s => s.value);
            const selectedTopic = setup.topicSelector.value;
            const allListsForTopic = (WORD_DATA[selectedTopic] && Object.keys(WORD_DATA[selectedTopic])) || [];

            currentSelectors.forEach(selectElement => {
                const currentValue = selectElement.value;
                const otherSelectedValues = selectedValues.filter(v => v !== currentValue);
                const availableLists = allListsForTopic.filter(list => !otherSelectedValues.includes(list));
                
                selectElement.innerHTML = '';
                availableLists.forEach(listName => {
                    const option = document.createElement('option');
                    option.value = listName;
                    option.textContent = listName;
                    selectElement.appendChild(option);
                });

                if (availableLists.includes(currentValue)) {
                    selectElement.value = currentValue;
                }
            });
            
            const canAddMore = currentSelectors.length < MAX_COMBINED_LISTS && currentSelectors.length < allListsForTopic.length;
            setup.addListBtn.disabled = !canAddMore;
        }

        function showScreen(screenName) { Object.values(screens).forEach(s => s.classList.remove('active')); screens[screenName].classList.add('active'); }
        function toggleFullscreen() { if (!document.fullscreenElement) { document.documentElement.requestFullscreen().catch(err => console.warn(`Vollbildfehler: ${err.message}`)); } else if (document.exitFullscreen) { document.exitFullscreen(); } }
        
        function updateSetupUI() { 
            setup.modeWordCloudBtn.classList.toggle('active', state.gameMode === 'wordcloud'); 
            setup.modeReadingBtn.classList.toggle('active', state.gameMode === 'reading');
            setup.modeEmojiQuizBtn.classList.toggle('active', state.gameMode === 'emojiQuiz');

            setup.wordCloudSettings.classList.toggle('active', state.gameMode === 'wordcloud'); 
            setup.readingModeSettings.classList.toggle('active', state.gameMode === 'reading'); 
            
            setup.baseSpeedSlider.value = state.baseAnimationSpeed; setup.baseSpeedValue.textContent = (state.baseAnimationSpeed / 1000).toFixed(1) + 's'; 
            setup.speedVarianceSlider.value = state.speedVariance; setup.speedVarianceValue.textContent = `±${state.speedVariance}%`; 
            setup.targetFrequencySlider.value = state.targetWordFrequency; setup.targetFrequencyValue.textContent = `${state.targetWordFrequency}%`; 
            
            setup.gridSmallBtn.classList.toggle('active', state.readingGridSize === 'small'); 
            setup.gridMediumBtn.classList.toggle('active', state.readingGridSize === 'medium'); 
            setup.gridLargeBtn.classList.toggle('active', state.readingGridSize === 'large'); 
            
            setup.soundToggleBtn.classList.toggle('active', soundsEnabled); setup.soundToggleBtn.textContent = soundsEnabled ? 'An' : 'Aus'; 
        }
        
        function endGame() {
            clearInterval(state.gameInterval);
            showScreen('gameOver');
            playSound(fanfareSoundBuffer);

            const container = document.getElementById('game-over-animation-container');
            const finalContent = document.getElementById('game-over-content');
            container.innerHTML = '';
            finalContent.style.display = 'none';

            const MIN_RAIN_ITEMS = 40; const MAX_RAIN_ITEMS = 70;
            let wordsToAnimate = [];
            if (state.wordList.length === 0) { finalContent.style.display = 'flex'; return; }
            if (state.wordList.length < MIN_RAIN_ITEMS) { for (let i = 0; i < MIN_RAIN_ITEMS; i++) { const randomWord = state.wordList[Math.floor(Math.random() * state.wordList.length)]; wordsToAnimate.push(randomWord); } } else { wordsToAnimate = shuffleArray([...state.wordList]).slice(0, MAX_RAIN_ITEMS); }
            wordsToAnimate.forEach(word => {
                const el = document.createElement('span'); el.textContent = word.emoji; el.classList.add('rain-word');
                const delay = Math.random() * 0.5; const duration = 3 + Math.random() * 2; const startX = Math.random() * 95; const fontSize = 1 + Math.random() * 2; const startRotation = -60 + Math.random() * 120; const endRotation = startRotation + (-360 + Math.random() * 720);
                el.style.setProperty('--start-rot', `${startRotation}deg`); el.style.setProperty('--end-rot', `${endRotation}deg`); el.style.left = `${startX}vw`; el.style.fontSize = `${fontSize}em`; el.style.animationDelay = `${delay}s`; el.style.animationDuration = `${duration}s`;
                container.appendChild(el);
                setTimeout(() => { if (el) el.remove(); }, (delay + duration) * 1000 + 200);
            });
            setTimeout(() => { finalContent.style.display = 'flex'; }, 1000);
        }

        initializeApp().catch(error => console.error("Initialisierung fehlgeschlagen."));
    });
    </script>
</body>
</html>
